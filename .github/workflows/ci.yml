name: CI

on:
  push:
    branches: [dev, main]
  pull_request:
    branches: [dev, main]
  workflow_dispatch:


permissions:
  contents: read

concurrency:
  group: cicd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    name: CI
    runs-on: ubuntu-24.04

    env:
      AZURE_STORAGE_CONNECTION_STRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://127.0.0.1:10000/devstoreaccount1;QueueEndpoint=http://127.0.0.1:10001/devstoreaccount1;TableEndpoint=http://127.0.0.1:10002/devstoreaccount1;"
      AzureWebJobsStorage: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://127.0.0.1:10000/devstoreaccount1;QueueEndpoint=http://127.0.0.1:10001/devstoreaccount1;TableEndpoint=http://127.0.0.1:10002/devstoreaccount1;"
      DELETE_TEST_OUTPUT_CONTAINER: "1"
      TEST_OUTPUT_CONTAINER: processed-tests-ci
      TEST_CARD_FOLDER: ci-${{ github.run_id }}
      HUGGINGFACE_HUB_TOKEN: ${{ secrets.HUGGINGFACE_HUB_TOKEN }}
      HF_TOKEN: ${{ secrets.HUGGINGFACE_HUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
          cache-dependency-path: |
            requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Start Azurite emulator
        run: |
          docker run --name azurite -d --rm \
            -p 10000:10000 -p 10001:10001 -p 10002:10002 \
            mcr.microsoft.com/azure-storage/azurite \
            azurite --skipApiVersionCheck \
            --blobHost 0.0.0.0 --blobPort 10000 \
            --queueHost 0.0.0.0 --queuePort 10001 \
            --tableHost 0.0.0.0 --tablePort 10002
          sleep 2

      - name: Lint, Format, and Type-Check
        run: |
          ruff check .
          ruff format . --check
          mypy . --ignore-missing-imports

      - name: Normalize test directory casing
        run: |
          if [ -d Tests ]; then
            mv Tests tests
          fi

      - name: Run tests
        run: python -m pytest -q

      - name: Stop Azurite emulator
        if: always()
        run: docker stop azurite
